<fieldset>
  <h3><%= title %></h3>
  <% if name.nil? %>
    <% name = "#{prefix}[#{attr_name}]" %>
    <% name << "[#{nested_name}]" if nested_name %>
  <% end %>
  <% id_name = "#{prefix}_#{attr_name}" %>

  <% data.each_with_index do |d,i| %>
    <% name = "#{prefix}[#{d.id}]" %>
    <% name << "[#{nested_name}]" if nested_name %>
    <% id_name = "#{prefix}_#{attr_name}" %>
    <% selected = if selected_data[d.id].nil? %>
        <% -1 %>
      <% elsif selected_data[d.id] %>
        <% 1 %>
      <% else %>
        <% 0 %>
      <% end %>

    <input  type="checkbox"
            name="<%= name %>"
            value="1"
            id="<%= id_name %>_<%= d.name %>"
            <%= "checked" if selected == 1 %>>
    <label for="<%= id_name %>_<%= d.name %>"><%= d.name %></label>
    <% attr_name += 1 %>
  <% end %>
</fieldset>


